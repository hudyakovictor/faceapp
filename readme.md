Концепт системы основан на поэтапной обработке каждой фотографии с использованием пяти библиотек: 3DDFA_v2, face-alignment (FAN), MediaPipe, scikit-image и InsightFace. Цель — выявление аномалий, масок и двойников на изображениях лица с максимальной точностью при минимальной сложности реализации. 

Каждый этап направлен на извлечение максимального количества данных о геометрии, текстуре и векторных признаках лица, при этом каждая библиотека используется по своему назначению и в строго определённой логике. Сначала каждая фотография обрабатывается 3DDFA, из неё извлекаются landmarks, а также углы наклона головы yaw/pitch/roll. 

На основе этих углов классифицируется ракурс одного из пяти типов: фронтальный, полупрофиль левый, полупрофиль правый, профиль левый, профиль правый. Далее к каждому ракурсу привязаны специфические метрики — активируются только те измерения, которые устойчивы для данного положения головы. Это позволяет исключить ошибки, связанные с тем, что фотографии имеют разброс внутри одного класса ракурса.

Далее, каждая метрика, полученная по точкам landmarks, снабжается дополнительным параметром confidence — это достоверность, зависящая от того, насколько углы головы соответствуют оптимальному диапазону для данной метрики. Если угол слишком отклонён от центрального значения, confidence снижается, либо метрика исключается из JSON. Такой подход позволяет оставить только высокоточные измерения, не прибегая к полной нормализации. 


После извлечения метрик 3DDFA подключается FAN, который выдаёт второй набор landmarks. 

Поскольку индексы у FAN и 3DDFA совпадают, можно напрямую рассчитать отклонения по ключевым точкам. Эти отклонения не записываются как абсолютные значения, а как разности между двумя библиотеками, в специальный блок deviation. Это критично важно, потому что маски или двойники часто искажают либо геометрию только в одной модели, либо делают лицо слишком симметричным, и это легко выявляется по резкому расхождению между двумя системами. 

Далее ограниченно подключается MediaPipe. Поскольку его landmarks несовместимы по индексам, он используется для расчёта лишь глобальных или устойчивых метрик: ширина лица, угол наклона бровей, форма подбородка и так далее. Однако метрики MediaPipe включаются в JSON только если у текущего кадра достаточно высокая достоверность по углам головы — то есть confidence от 3DDFA выше определённого порога.

После этого InsightFace извлекает embedding лица — 512-мерный вектор. Он добавляется в JSON и используется позже для кластеризации. Этот вектор в дальнейшем позволит объединять одинаковые лица, находить повторяющихся людей, даже если внешне они выглядят иначе. От InsightFace также можно получить возраст и эмоцию, но эти данные не сохраняются, чтобы не увеличивать шум. На основе всех вышеуказанных данных формируется финальный JSON, который содержит несколько блоков.

Первый блок — параметры от 3DDFA: углы головы, shape error, ракурс, landmarks. 

Второй блок — метрики от всех библиотек с префиксами (по библиотеке и ракурсу), в каждой метрике указывается не только значение, но и confidence.

Третий блок — отклонения между FAN и 3DDFA.

Четвёртый блок — текстурные признаки.. 

пятый блок — embedding и признаки из InsightFace. 

Дополнительно присутствует флаг is_anomalous, который активируется при выполнении нескольких условий: если shape_error выше порога, если расхождения между FAN и 3DDFA выше допустимого процента, и если текстура лица слишком однородна. Все метрики делятся по ракурсам и библиотекам, и имеют стандартизированные ключи. 

Итоговая структура позволяет без нормализации, но с учетом confidence и ракурса, получать максимально надёжный JSON, пригодный для автоматического анализа. 

Так можно автоматически отсеять маски, построить классификацию двойников, выявить повторяющиеся типы. 

Система легко масштабируется, потому что каждый JSON самодостаточен, а структура заранее учитывает фильтрацию по confidence, ракурсу, типу метрик. Обработка делается одним скриптом без внешней зависимости от GUI, только с генерацией одного изображения с наложением landmarks и сохранением нескольких опций от 3DDFA (json, obj или ply). Такой подход обеспечивает идеальный баланс между точностью, простотой и скоростью внедрен
